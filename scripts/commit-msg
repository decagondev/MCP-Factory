#!/usr/bin/env bash
#
# commit-msg hook: strips AI tool branding and advertising from commit messages.
# Install: cp scripts/commit-msg .git/hooks/commit-msg && chmod +x .git/hooks/commit-msg

set -euo pipefail

COMMIT_MSG_FILE="$1"

AI_TOOLS="Claude|Cursor|Copilot|GitHub Copilot|ChatGPT|GPT-4|GPT-4o|OpenAI|Anthropic|Gemini|Google Gemini|Windsurf|Codeium|Tabnine|Amazon Q|CodeWhisperer|Sourcegraph Cody|Replit AI|Devin|Aider|Continue|JetBrains AI"

ATTRIBUTION_VERBS="Generated by|Created with|Made with|Built with|Written by|Authored by|Assisted by|Powered by|Suggested by|Produced by|Refactored by|Fixed by"

MARKETING="AI-powered|AI-generated|AI-assisted|LLM-assisted|LLM-generated|machine-generated"

original=$(cat "$COMMIT_MSG_FILE")

filtered=$(echo "$original" \
    | grep -viE "(${ATTRIBUTION_VERBS})\s+(${AI_TOOLS})" \
    | grep -viE "^(Co-authored-by|Signed-off-by|Reviewed-by):.*\b(${AI_TOOLS})\b" \
    | grep -viE "\b(${MARKETING})\b" \
    | grep -vE "^ðŸ¤–" \
    || true)

filtered=$(echo "$filtered" | perl -0777 -pe 's/^\n+//; s/\n+$//')

if [ -z "$(echo "$filtered" | tr -d '[:space:]')" ]; then
    echo >&2 "ERROR: commit message is empty after stripping AI branding."
    echo >&2 "Please write a meaningful commit message without AI tool references."
    exit 1
fi

if [ "$original" != "$filtered" ]; then
    echo >&2 "WARNING: AI branding was stripped from your commit message."
    echo "$filtered" > "$COMMIT_MSG_FILE"
fi
